<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <script src="jquery/jquery.min.js"></script>
  <script src="popper/popper.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="requirejs/require.js"></script>
  <script>var workshop_base_url = "/user/user3/workshop";</script>
  
  <link rel="stylesheet" href="asciidoctor/css/asciidoctor.css">
  
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="fontawesome/css/all.min.css">
  <link rel="stylesheet" href="css/workshop.css">
  <link rel="stylesheet" href="css/workshop-asciidoc.css">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135921114-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());
  gtag("config", "UA-135921114-11");
</script>

</head>
</body>
  <!-- Header -->
  <header class="header">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-6">
          <a href="" class="logo">Starter Labs (Java)</a>
        </div>
      </div>
    </div>
  </header>
  <!-- Main -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-3 d-sm-block d-none">
        <!-- Table of Contents -->
        <ul class="menu">
          <li class="category">
            <ul class="modules">
              <h5 class="category-title">Workshop Modules</h5>
              
                
                  <li class="page"><a href="common-workshop-summary.html">Workshop Summary</a></li>
                
              
                
                  <li class="page"><a href="common-environment.html">Environment Overview</a></li>
                
              
                
                  <li class="page"><a href="common-using-homeroom.html">Using Homeroom</a></li>
                
              
                
                  <li class="page"><a href="common-parksmap-architecture.html">Architecture Overview of the ParksMap Application</a></li>
                
              
                
                  <li class="page"><a href="common-explore.html">Exploring the CLI and Web Console</a></li>
                
              
                
                  <li class="page"><a href="parksmap-container-image.html">Deploying Your First Container Image</a></li>
                
              
                
                  <li class="page"><a href="parksmap-scaling.html">Scaling and Self Healing</a></li>
                
              
                
                  <li class="page"><a href="parksmap-routes.html">Exposing Your Application to the Outside World</a></li>
                
              
                
                  <li class="page"><a href="parksmap-logging.html">Exploring OpenShift's Logging Capabilities</a></li>
                
              
                
                  <li class="page"><a href="parksmap-permissions.html">Role-Based Access Control</a></li>
                
              
                
                  <li class="page"><a href="parksmap-rsh.html">Remote Access to Your Application</a></li>
                
              
                
                  <li class="page"><a href="nationalparks-java.html">Deploying Java Code</a></li>
                
              
                
                  <li class="page"><a href="nationalparks-java-databases.html">Adding a Database (MongoDB)</a></li>
                
              
                
                  <li class="page"><a href="nationalparks-java-application-health.html">Application Health</a></li>
                
              
                
                  <li class="page"><a href="nationalparks-java-pipeline.html">Automate Build and Deployment with Pipelines</a></li>
                
              
                
                  <li class="page active"><a href="nationalparks-java-pipeline-codechanges-gogs.html">Automation for Your Application on Code Changes</a></li>
                
              
                
                  <li class="page"><a href="mlbparks-templates.html">Using Application Templates</a></li>
                
              
                
                  <li class="page"><a href="mlbparks-binary-build.html">Binary Builds for Day to Day Development</a></li>
                
              
                
                  <li class="page"><a href="common-further-resources.html">Further Resources</a></li>
                
              
                
                  <li class="page"><a href="common-workshop-links.html">Workshop Links</a></li>
                
              
            </ul>
          </li>
        </ul>
      </div>
      <div class="col-sm-9">
        <section class="page-content">
          <!-- Top Navigation -->
          <div class="btn-group btn-group-xs float-right">
            
              <button type="button" onclick="location.href='nationalparks-java-pipeline';" class="btn btn-xs btn-transparent" aria-label="Prev">
                <span class="fas fa-arrow-left" aria-hidden="true"></span>
              </button>
            
            <button type="button" onclick="location.href='';" class="btn btn-xs btn-transparent" aria-label="Home">
              <span class="fas fa-home" aria-hidden="true"></span>
            </button>
            
              <button type="button" onclick="location.href='mlbparks-templates';" class="btn btn-xs btn-transparent" aria-label="Next">
                <span class="fas fa-arrow-right" aria-hidden="true"></span>
              </button>
            
          </div>
          <!-- Title -->
          
            <h1 class="title">Automation for Your Application on Code Changes</h1>
          
          <!-- Content -->
          <div class="sect1">
<h2 id="_background_web_hooks">Background: Web Hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most Git repository servers support the concept of web hooks&#8201;&#8212;&#8201;calling to an
external source via HTTP(S) when a change in the code repository happens.
OpenShift provides an API endpoint that supports receiving hooks from
remote systems in order to trigger builds. By pointing the code repository&#8217;s
hook at the OpenShift Pipelines resources, automated code/build/deploy pipelines can be
achieved.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_triggers_to_your_pipeline">Adding Triggers to your Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tekton <strong>Triggers</strong> enable us to configure Pipelines to respond to external events (Git push events, pull requests etc) such as Web Hooks.</p>
</div>
<div class="paragraph">
<p>Adding triggering support requires the creation of a <code>TriggerTemplate</code>, <code>TriggerBinding</code>, and an <code>EventListener</code> in our project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/devops-pipeline-triggers.png" alt="Triggers">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see each component in detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>TriggerTemplate</strong>: a trigger template is a template for newly created resources. It supports parameters to create specific <code>PipelineResources</code> and <code>PipelineRuns</code>.</p>
</li>
<li>
<p><strong>TriggerBinding</strong>: validates events and extracts payload fields</p>
</li>
<li>
<p><strong>EventListener</strong>: connects <code>TriggerBindings</code> and <code>TriggerTemplates</code> into an addressable endpoint (the event sink). It uses the extracted event parameters from each TriggerBinding (and any supplied static parameters) to create the resources specified in the corresponding TriggerTemplate. It also optionally allows an external service to pre-process the event payload via the interceptor field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now let&#8217;s create them all together for our Pipeline:</p>
</div>
<div class="listingblock execute-1">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">oc create -f http://gogs-labs.apps.cluster-test-efcf.test-efcf.example.opentlc.com/user3/nationalparks/raw/master/pipeline/nationalparks-triggers-all.yaml -n user3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a new Pod with a Route that we can use to setup our Webhook on Gogs to trigger the automatic start of the Pipeline.</p>
</div>
<div class="paragraph">
<p>From left side menu, click on <strong>Topology</strong> to verify if a new Deployment <strong>el-nationalparks</strong> for the <code>EventListener</code> has ben created:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/devops-pipeline-triggers-eventlistener.png" alt="EventListener created">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_configuring_gogs_web_hooks">Exercise: Configuring Gogs Web Hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Click on the Deployment, go into <strong>Routes</strong> section and and copy the <strong>el-nationparks</strong> Route URL.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/devops-pipeline-triggers-route.png" alt="EventListener created">
</div>
</div>
<div class="paragraph">
<p>Once you have the URL copied to your clipboard, navigate to the code repository that you have on Gogs:</p>
</div>
<div class="paragraph">
<p><a href="http://gogs-labs.apps.cluster-test-efcf.test-efcf.example.opentlc.com/user3/nationalparks">Gogs Repository</a></p>
</div>
<div class="paragraph">
<p>Your Gogs credentials are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">username: user3
password: gogs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click the Settings link on the top right of the screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nationalparks-codechanges-gogs-settings.png" alt="Webhook">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Webhooks</strong>, then the <strong>Add Webhook</strong> button, and finally select <strong>Gogs</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nationalparks-codechanges-gogs-add-webhook.png" alt="Webhook">
</div>
</div>
<div class="paragraph">
<p>In the next screen, paste your link into the "Payload URL" field. You can leave the
secret token field blank&#8201;&#8212;&#8201;the secret is already in the URL and does not need
to be in the payload.</p>
</div>
<div class="paragraph">
<p>Change the <code>Content Type</code> to <code>application/json</code>.</p>
</div>
<div class="paragraph">
<p>Finally, click on <strong>Add Webhook</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nationalparks-codechanges-gogs-config-webhook.png" alt="Webhook">
</div>
</div>
<div class="paragraph">
<p>Boom! From now on, every time you commit new source code to your Gogs
repository, a new build and deploy will occur inside of OpenShift.  Let&#8217;s try
this out.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_using_gogs_web_hooks">Exercise: Using Gogs Web Hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Click the <strong>Files</strong> tab in Gogs. This is Gogs&#8217;s repository view.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Make sure that the drop-down menu at the upper right is set for
the <strong><code>master</code></strong> branch. Navigate to the
following path:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">src/main/java/com/openshift/evg/roadshow/parks/rest/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then click on the <code>BackendController.java</code> file.</p>
</div>
<div class="paragraph">
<p>Once you have the file on the screen, click the edit button in the top right
hand corner as shown here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nationalparks-codechanges-gogs-change-code.png" alt="Webhook">
</div>
</div>
<div class="paragraph">
<p>Change line number 20:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">return new Backend("nationalparks","National Parks", new Coordinates("47.039304", "14.505178"), 4);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">return new Backend("nationalparks","Amazing National Parks", new Coordinates("47.039304", "14.505178"), 4);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click on Commit changes at the bottom of the screen. Feel free to enter a commit
message.</p>
</div>
<div class="paragraph">
<p>Once you have committed your changes, a new <strong>PipelineRun</strong> should almost instantaneously be
triggered in OpenShift. Click <strong>Pipeline</strong> in the left navigation menu then <code>nationalparks-pipeline</code>. You should see a new one running:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nationalparks-codechanges-pipeline-running.png" alt="Webhook">
</div>
</div>
<div class="paragraph">
<p>or run the following command to verify:</p>
</div>
<div class="listingblock execute-1">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">oc get PipelineRun</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the build and deploy has finished, verify your new image was automatically deployed by viewing the application in your browser:</p>
</div>
<div class="paragraph">
<p><a href="http://nationalparks-user3.apps.cluster-test-efcf.test-efcf.example.opentlc.com/ws/info/">National Parks Info Page</a></p>
</div>
<div class="paragraph">
<p>You should now see the new name you have set in the JSON string returned.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To see this in the map&#8217;s legend itself, you will need to scale down your parksmap to 0, then back up to 1 to force the app to refresh its cache.
</td>
</tr>
</table>
</div>
</div>
</div>
          <!-- Bottom Navigation -->
          <div class="page-meta clearfix">
            
              
                <input type="button" class="btn btn-lg btn-primary float-right" onclick="location.href='mlbparks-templates';" value="Continue" />
              
            
          </div>
        </section>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="footer">
  </footer>
  <!-- Javascript-->
  <script src="js/workshop.js"></script>
  <script src="js/workshop-asciidoc.js"></script>
</body>
</html>
